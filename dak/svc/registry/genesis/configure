#!/usr/bin/env bash

. ../../../util/public/bash-tpl/bash-tpl # {{{1
. ../../../util/meta/lib/util.sh
. $(local_env ../../../..)

echo "- starting $0 on $(date): DIDALIK $DIDALIK" # {{{1
SVC_PATH=${npm_config_svc_path:-../svc}
isSubDir $(dirname $SVC_PATH) . && { 
  echo "INVALID SVC_PATH $SVC_PATH: subdir of $PWD" >&2; exit 2
} || echo "- SVC_PATH $SVC_PATH is outside of $PWD"
mkdir svc; cd svc; touch .env

keys=() # [OWNER_SK, OWNER_PK, SVC_SK, SVC_PK] {{{2
for t in 'OWNER' 'SVC'; do
  for key in "$($RUN_MJS generate_keypair)"; do keys+=($key); done
done
putenv OWNER_PK "'${keys[1]}'" .env
putenv OWNER_SK "'${keys[0]}'" .env
putenv SVC_NAME $(basename $(dirname $(realpath ..))) .env
putenv SVC_PATH $SVC_PATH .env
putenv SVC_PK "'${keys[3]}'" .env
putenv SVC_SK "'${keys[2]}'" .env
putenv SVC_START "'wrangler dev dist/index.mjs'" .env
putenv SVC_URL $(vault_url $VAULT_URL_USER $VAULT_URL_HOST $SVC_PATH) .env
putenv THIS_SCRIPT $0 .env
putenv TIMESTAMP_NOW "'$(date)'" .env
. .env

# }}}2

cd - > /dev/null

echo -e "- exiting $0 on $(date)\n" # {{{1

exit

[ -e ../config-templates/meta.ts ] || { # {{{2
  echo '- configuring KV'
  envsubst < ../config-meta/wrangler.toml > wrangler.toml
  id=$(wrangler kv:namespace create KVNS_DO_ID | tail -n 1)
  id=${id#*id = ?}
  export KVNS_DO_ID_BINDING=${id%? *}
  id=$(wrangler kv:namespace create KVNS_DO_ID --preview | tail -n 1)
  id=${id#*preview_id = ?}
  export KVNS_DO_ID_BINDING_PREVIEW=${id%? *}
  echo '- updating templates'
  envsubst < ../config-meta/src/index.mjs > ../config-templates/src/index.mjs
  envsubst < ../config-meta/src/module-worker.mjs > ../config-templates/src/module-worker.mjs
  envsubst < ../config-meta2/wrangler.toml > wrangler.toml
  cp wrangler.toml ../config-templates/
  touch ../config-templates/meta.ts
}

envsubst < ../config-templates/Makefile > Makefile # {{{2
envsubst < ../config-templates/wrangler.toml > wrangler.toml # FIXME
mkdir bin; cp -a ../bin/build.sh ../bin/test.sh bin/ # TODO move ../bin/build.sh to org
cp -a ../config-templates/src/ .
cp -a ../registry/org ../registry/public .
envsubst < ../config-templates/package.json > package.json
wrangler dev --port ${npm_config_port:-8787} dist/index.mjs

# }}}2
